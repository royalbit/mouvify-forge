@startuml forge-architecture-overview
!theme plain
title Forge v1.1.0 Architecture Overview

' ==============================================================================
' Purpose: High-level architecture showing main components and data flow
' Version: v1.1.0 (27 Excel functions, bidirectional Excel integration)
' Last Updated: 2025-11-24
' ==============================================================================

' Core Components
package "Core Engine" {
  [Parser] as parser
  [Array Calculator] as calc
  [Dependency Resolver] as deps
  [YAML Writer] as writer
  [Validator] as valid
}

' CLI Layer
package "CLI Interface" {
  [Command Handler] as cli
  component "forge calculate" as cmd_calc
  component "forge validate" as cmd_valid
  component "forge export" as cmd_export
  component "forge import" as cmd_import
}

' Excel Integration
package "Excel Bridge" {
  [Excel Exporter] as export
  [Excel Importer] as import
  [Formula Translator] as trans_out
  [Reverse Translator] as trans_in
}

' External Dependencies
package "External Libraries" {
  database "xlformula_engine" as xle #LightGray
  database "serde_yaml" as yaml #LightGray
  database "rust_xlsxwriter" as xlsx #LightGray
  database "calamine" as cala #LightGray
  database "petgraph" as graph #LightGray
  database "jsonschema" as schema #LightGray
}

' User and Files
actor User
file "model.yaml" as yaml_file
file "output.xlsx" as xlsx_file
file "forge-v1.0.schema.json" as schema_file

' CLI Connections
User --> cli
cli --> cmd_calc
cli --> cmd_valid
cli --> cmd_export
cli --> cmd_import

' Core Workflow
cmd_calc --> parser : Parse YAML
cmd_valid --> parser : Parse + Validate
cmd_export --> parser : Parse → Export
cmd_import --> import : Import → Parse

parser --> yaml : Read YAML
parser --> schema : Validate against schema
parser --> calc : Parsed model

calc --> deps : Resolve dependencies
deps --> graph : Topological sort
calc --> xle : Evaluate formulas
calc --> writer : Calculated values

writer --> yaml : Write YAML
valid --> yaml_file : Check values

' Excel Integration Flow
cmd_export --> export
export --> trans_out : Translate formulas
trans_out --> xlsx : Write Excel
xlsx --> xlsx_file

cmd_import --> import
import --> cala : Read Excel
cala --> xlsx_file
import --> trans_in : Reverse translate
trans_in --> yaml : Convert to YAML

' Notes
note right of calc
  **47+ Excel Functions**
  - Conditional: SUMIF, COUNTIF, etc.
  - Math: ROUND, SQRT, POWER, etc.
  - Text: CONCAT, TRIM, UPPER, etc.
  - Date: TODAY, YEAR, MONTH, etc.
end note

note right of deps
  **Dependency Resolution**
  - Topological sort (petgraph)
  - Detects circular dependencies
  - Evaluates in correct order
end note

note right of trans_out
  **YAML → Excel Translation**
  - Column refs → Cell refs
  - profit = revenue - expenses
  → B2 = A2 - C2
end note

note right of trans_in
  **Excel → YAML Translation**
  - Cell refs → Column refs
  - =A2-C2 → =revenue - expenses
  - Preserves formulas
end note

note left of parser
  **v1.0.0 Array Model**
  - Type-safe column arrays
  - Homogeneous types only
  - Row-wise formulas
  - Aggregation formulas
end note

' Legend
legend right
  **Color Coding**
  * White = Forge components
  * Gray = External libraries

  **Architecture Pattern**
  * Modular design
  * Clear separation of concerns
  * Bidirectional Excel integration
  * Zero hallucinations (deterministic)
endlegend

@enduml
